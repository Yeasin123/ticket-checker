name: Check Tickets

on:
  push:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *' # Runs every minute

jobs:
  check_tickets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache previous data
        id: cache
        uses: actions/cache@v4
        with:
          path: previous_coaches.json
          key: ${{ runner.os }}-coaches-data

      - name: Check Coaches API
        id: check_api
        run: |
          response=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          -d '{ "date": "2024-04-05", "identifier": "dhaka-to-rajshahi", "structureType": "BUS" }' \
          https://api.bdtickets.com:20102/v1/coaches/search)
          echo "$response" | jq '.data[] | {companyName, arrivaleTime}' > new_coaches.json

      - name: Compare data
        id: compare
        run: |
          if [ -f "previous_coaches.json" ]; then
            if ! cmp -s new_coaches.json previous_coaches.json; then
              echo "data_changed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "data_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Check data
        run: |
          echo "Data changed: ${{ steps.compare.outputs.data_changed }}"
          cat new_coaches.json
          cat previous_coaches.json

      - name: Send Slack message if data changed
        if: steps.compare.outputs.data_changed == 'true'
        run: |
          mv new_coaches.json previous_coaches.json
          curl -X POST \
            -H 'Content-Type: application/json' \
            --data "{'text':'$(cat coaches.json) ---- https://bdtickets.com/bus/search/dhaka-to-rajshahi?journeyDate=2024-04-05'}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Cache updated data
        if: steps.compare.outputs.data_changed == 'true'
        uses: actions/cache@v4
        with:
          path: previous_coaches.json
          key: ${{ runner.os }}-coaches-data
